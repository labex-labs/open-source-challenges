# Bash Trap Command

## Introduction

In this lab, we will explore the `trap` command in Bash scripting. The `trap` command is a powerful tool that allows you to catch and handle signals, interruptions, and user inputs in your scripts. By using `trap`, you can define specific actions to be taken when particular signals are received, enabling you to manage unpredictable behavior and gracefully handle various scenarios. This lab is designed for beginners and will guide you through the process of using the `trap` command effectively.

## Steps

### Step 1: Create a Bash Script

Let's start by creating a new Bash script file where we'll implement the `trap` command.

1. Open a terminal in the WebIDE. You should see a prompt ending with a `$` symbol.

2. Navigate to the project directory:

   ```bash
   cd ~/project
   ```

   This command changes your current working directory to `/home/labex/project`.

3. Create a new file named `trap_example.sh`:

   ```bash
   touch trap_example.sh
   ```

   The `touch` command creates an empty file if it doesn't exist, or updates the modification time if it does.

4. Open the `trap_example.sh` file in the WebIDE editor. You can do this by clicking on the file name in the file explorer on the left side of the WebIDE.

#### Verification

```yaml
- name: Verify file creation
  script: |
    #!/bin/bash
    if [ -f ~/project/trap_example.sh ]; then
      exit 0
    else
      exit 1
    fi
  hint: |
    Make sure you have created the file 'trap_example.sh' in the ~/project directory. If you're having trouble, try running the 'touch' command again.
```

### Step 2: Implement a Basic Trap Command

Now, let's implement a basic `trap` command in our script to catch specific signals.

1. Add the following content to the `trap_example.sh` file:

   ```bash
   #!/bin/bash
   
   trap "echo Signal received!" SIGINT SIGTERM
   
   echo "This script will run until you press Ctrl+C."
   echo "Press Ctrl+C to see the trap in action."
   
   while true; do
     sleep 1
   done
   ```

   Let's break down this script:

   - The first line `#!/bin/bash` is called a shebang. It tells the system that this script should be executed by the Bash shell.

   - The `trap` command is set up to echo "Signal received!" when it catches either SIGINT (interrupt) or SIGTERM (termination) signals. SIGINT is typically sent when you press Ctrl+C, while SIGTERM is often used when a process is asked to terminate gracefully.

   - The `echo` commands print instructions for the user.

   - The `while true; do` creates an infinite loop. This keeps our script running so we can test the trap.

   - `sleep 1` pauses the script for 1 second in each iteration of the loop. This prevents the script from consuming too much CPU time.

2. Save the file after adding the content. In most text editors, you can do this by pressing Ctrl+S or by clicking on a "Save" button.

#### Verification

```yaml
- name: Verify script content
  script: |
    #!/bin/bash
    if grep -q "trap \"echo Signal received!\" SIGINT SIGTERM" ~/project/trap_example.sh; then
      exit 0
    else
      exit 1
    fi
  hint: |
    Ensure that you have added the trap command to the script as instructed. Check for typos and make sure you've saved the file.
```

### Step 3: Make the Script Executable and Run It

Before we can run our script, we need to make it executable. This tells the system that this file is allowed to be run as a program.

1. In the terminal, make the script executable:

   ```bash
   chmod +x ~/project/trap_example.sh
   ```

   The `chmod` command changes the permissions of a file. The `+x` option adds execute permission.

2. Run the script:

   ```bash
   ~/project/trap_example.sh
   ```

   This command tells Bash to execute our script.

3. The script will start running. You'll see the instructions printed on the screen. Let it run for a few seconds.

4. Now, press Ctrl+C to interrupt it. You should see the message "Signal received!" before the script exits. This is our trap in action!

5. If the script doesn't exit after the first Ctrl+C (which can happen depending on how the terminal handles signals), press Ctrl+C again to stop the script completely.

#### Verification

```yaml
- name: Verify script permissions
  script: |
    #!/bin/bash
    if [ -x ~/project/trap_example.sh ]; then
      exit 0
    else
      exit 1
    fi
  hint: |
    Make sure you've made the script executable using the chmod command. If you're having trouble, try running the chmod command again.
```

### Step 4: Modify the Trap to Use a Function

Instead of using an inline command, let's modify our script to use a function with the `trap` command. This allows us to perform more complex actions when a signal is received.

1. Open the `trap_example.sh` file in the WebIDE editor.

2. Replace the content of the file with the following:

   ```bash
   #!/bin/bash
   
   handle_signal() {
     echo "Signal received! Cleaning up..."
     echo "Exiting script."
     exit 0
   }
   
   trap handle_signal SIGINT SIGTERM
   
   echo "This script will run until you press Ctrl+C."
   echo "Press Ctrl+C to see the trap function in action."
   
   while true; do
     sleep 1
   done
   ```

   Let's examine the changes:

   - We've defined a function called `handle_signal`. In Bash, you define a function by writing its name followed by parentheses `()`.

   - Inside the function, we echo two messages and then use `exit 0` to end the script. The `0` means the script ended successfully.

   - We've updated the `trap` command to call our `handle_signal` function instead of just echoing a message.

3. Save the file after making these changes.

4. Run the script again and test it by pressing Ctrl+C:

   ```bash
   ~/project/trap_example.sh
   ```

   You should see the new messages from the `handle_signal` function when you interrupt the script.

#### Verification

```yaml
- name: Verify function definition
  script: |
    #!/bin/bash
    if grep -q "handle_signal()" ~/project/trap_example.sh; then
      exit 0
    else
      exit 1
    fi
  hint: |
    Make sure you have defined the handle_signal function in the script. Check for typos in the function name.
```

### Step 5: Use Signal Numbers in the Trap Command

Instead of using signal names, we can use their corresponding numbers in the `trap` command. This is sometimes preferred for portability, as signal numbers are standardized across POSIX systems.

1. In the terminal, run the following command to see a list of signal numbers:

   ```bash
   kill -l
   ```

   This command lists all available signals with their corresponding numbers. Look for SIGINT and SIGTERM in this list.

2. Modify the `trap_example.sh` file to use signal numbers. Replace the content with:

   ```bash
   #!/bin/bash
   
   handle_signal() {
     echo "Signal received! Cleaning up..."
     echo "Exiting script."
     exit 0
   }
   
   trap handle_signal 2 15
   
   echo "This script will run until you press Ctrl+C."
   echo "Press Ctrl+C to see the trap function in action."
   
   while true; do
     sleep 1
   done
   ```

   Here's what changed:

   - We replaced `SIGINT` with `2` and `SIGTERM` with `15`.
   - These numbers correspond to the SIGINT and SIGTERM signals, respectively. You can verify this in the output of the `kill -l` command.

3. Save the file after making these changes.

4. Run the script again and test it by pressing Ctrl+C:

   ```bash
   ~/project/trap_example.sh
   ```

   The behavior should be the same as before, but now we're using signal numbers instead of names.

#### Verification

```yaml
- name: Verify trap with signal numbers
  script: |
    #!/bin/bash
    if grep -q "trap handle_signal 2 15" ~/project/trap_example.sh; then
      exit 0
    else
      exit 1
    fi
  hint: |
    Make sure you have updated the trap command to use signal numbers (2 and 15) instead of signal names. Check for typos and ensure you've saved the file.
```

## Summary

In this lab, you learned how to use the `trap` command in Bash scripting. You created a script that catches specific signals and defines actions to be taken when those signals are received. You explored different ways of using the `trap` command, including using inline commands, functions, and signal numbers.

The `trap` command is a powerful tool for handling interruptions and performing cleanup actions in your Bash scripts. It allows you to create more robust and user-friendly command-line applications by gracefully handling unexpected terminations and user interrupts.

Remember, the ability to handle signals can be crucial in many scripting scenarios, such as ensuring proper cleanup of temporary files, closing network connections, or saving state before a script exits unexpectedly.
